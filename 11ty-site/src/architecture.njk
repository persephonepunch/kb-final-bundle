---
layout: layouts/base.njk
title: Architecture
permalink: /architecture/
---

<div class="page-content">
  <div class="page-header">
    <h1 class="page-title">Architecture Overview</h1>
    <p class="page-description">
      Complete data flow architecture from the client-side in Webflow to the backend services.
    </p>
  </div>

  <div class="section">
    <div class="card">
      <h2 class="card-title-large">Data Flow Diagram</h2>
      <div class="diagram-container">
        <pre class="diagram">
┌─────────────────────────────────────────────────────────┐
│         Client Webflow/11ty/Shopify Liquid Theme        │
│  ┌────────────────────────────────────────────────┐    │
│  │  User → UCP Session → Consent UI → History    │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│            Middleware (Xano/n8n)                        │
│  ┌────────────────────────────────────────────────┐    │
│  │  Webhook → Workflow → Transform & Enrich      │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                    ↓                ↓
        ┌───────────────┐  ┌───────────────────┐
        │    Shopify    │  │   Google AI       │
        │  Metaobjects  │  │  Data Stream      │
        │   Customer    │  │  AI Processing    │
        └───────────────┘  └───────────────────┘
                          ↑
                    WebSocket
                    Real-time Updates
        </pre>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">1. Client Webflow/11ty/Shopify Liquid Theme</h2>
    <p class="section-intro">
      The user interacts with Front End (Webflow Design Modules/11ty templates) paired with Shopify Native Mirror of synced front end. All user actions, session data, and consent changes are captured on the client-side.
    </p>
    
    <div class="feature-list">
      <div class="feature-card">
        <h3 class="feature-title">UCP Session Management</h3>
        <p class="feature-description">
          A client-side JavaScript module manages the UCP session, handling session creation, data storage in localStorage or sessionStorage, and retrieval. The session includes a unique session ID, user authentication status, and session-specific information.
        </p>
        <div class="code-inline">
          <code>sessionId, userId, email, consentStatus, userHistory</code>
        </div>
      </div>

      <div class="feature-card">
        <h3 class="feature-title">User History Tracking</h3>
        <p class="feature-description">
          JavaScript event listeners capture all significant user actions such as page views, button clicks, and form submissions. Each event is stored with a timestamp, event type, and relevant metadata.
        </p>
      </div>

      <div class="feature-card">
        <h3 class="feature-title">Consent Management</h3>
        <p class="feature-description">
          A consent management UI allows users to grant or revoke consent for different data processing purposes. Consent status is stored in the UCP session and persisted in localStorage. When consent changes, a webhook is triggered to notify the middleware.
        </p>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">2. Middleware (Xano/n8n)</h2>
    <p class="section-intro">
      The middleware processes incoming webhooks, transforms and enriches data, and orchestrates the data flow to backend services.
    </p>

    <div class="feature-list">
      <div class="feature-card feature-card-accent">
        <h3 class="feature-title">Webhook Endpoint</h3>
        <p class="feature-description">
          A webhook endpoint receives POST requests from the Webflow front-end, triggered by significant events like consent changes or page views.
        </p>
      </div>

      <div class="feature-card feature-card-accent">
        <h3 class="feature-title">Data Transformation</h3>
        <p class="feature-description">
          The workflow parses incoming JSON payloads and transforms data into the format required by Shopify and Google AI APIs. This includes renaming fields, restructuring data, and enriching with additional information like IP geolocation.
        </p>
      </div>

      <div class="feature-card feature-card-accent">
        <h3 class="feature-title">Idempotency Checks</h3>
        <p class="feature-description">
          All operations implement idempotency checks to prevent duplicate processing. Each operation is assigned a unique key and logged to ensure data consistency.
        </p>
        <div class="code-inline">
          <code>idempotencyKey = sessionId_eventType_timestamp</code>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">3. Backend Services</h2>
    
    <div class="backend-grid">
      <div class="card">
        <h3 class="card-title">Shopify Metaobjects</h3>
        <p class="card-description">
          Custom Metaobject definitions store user consent status, browsing history, and last active timestamps. These are associated with customer records for comprehensive user profiles.
        </p>
        <ul class="data-list">
          <li><span class="data-bullet">▪</span> <code>consent_status: JSON</code></li>
          <li><span class="data-bullet">▪</span> <code>user_history: JSON</code></li>
          <li><span class="data-bullet">▪</span> <code>last_seen: DateTime</code></li>
        </ul>
      </div>

      <div class="card">
        <h3 class="card-title">Google AI Data Stream</h3>
        <p class="card-description">
          User interaction data is streamed to Google AI Platform for real-time analysis, enabling personalization, recommendations, and analytics dashboards.
        </p>
        <ul class="data-list">
          <li><span class="data-bullet data-bullet-accent">▪</span> Real-time analytics</li>
          <li><span class="data-bullet data-bullet-accent">▪</span> ML model training</li>
          <li><span class="data-bullet data-bullet-accent">▪</span> Personalization</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">4. Real-time Updates</h2>
    <div class="card card-highlight">
      <h3 class="card-title">WebSocket Communication</h3>
      <p class="card-description">
        The middleware emits events via WebSockets to the client-side, allowing for real-time updates to the user interface based on backend processing. This enables instant feedback for consent confirmations, personalization updates, and other user-facing changes.
      </p>
      <div class="code-inline">
        <code>Client ← WebSocket ← Middleware → Backend Services</code>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">Security Considerations</h2>
    <div class="security-list">
      <div class="security-card">
        <h3 class="security-title">Data Encryption</h3>
        <p class="security-description">
          All data in transit between the client, middleware, and backend services MUST be encrypted using TLS. Sensitive user data stored in Shopify Metaobjects should be encrypted at rest.
        </p>
      </div>

      <div class="security-card">
        <h3 class="security-title">Authentication</h3>
        <p class="security-description">
          All API requests to the middleware and backend services MUST be authenticated using API keys or OAuth 2.0 tokens. Webhooks from Webflow should be secured using a secret key to verify authenticity.
        </p>
      </div>

      <div class="security-card">
        <h3 class="security-title">Consent Management</h3>
        <p class="security-description">
          User consent preferences MUST be respected at all times. Data should only be processed for purposes for which the user has given explicit consent.
        </p>
      </div>
    </div>
  </div>
</div>
